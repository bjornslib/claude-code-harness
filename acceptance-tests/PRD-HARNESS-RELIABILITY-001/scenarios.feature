# Guardian Acceptance Test Scenarios: PRD-HARNESS-RELIABILITY-001
# Harness Reliability + Setup Hook Integration
#
# Generated by: s3-guardian
# Date: 2026-02-20T00:03:58Z
#
# BLIND RUBRIC: Operators CANNOT see this file.
# Scoring is 0.0-1.0 gradient per scenario.

Feature: F1 — Setup-Harness Hook Auto-Installation
  Weight: 0.35
  Description: Running /setup-harness on a git repo automatically installs pre-push hook via symlink. Non-git directories handled gracefully. Existing hooks not overwritten.

  Scenario: setup_harness_installs_hook
    Given a target directory that is a git repository
    And the target has .claude/hooks/doc-gardener-pre-push.sh after harness copy
    When /setup-harness is run (or the SKILL.md workflow is followed)
    Then a symlink exists at .git/hooks/pre-push pointing to .claude/hooks/doc-gardener-pre-push.sh
    And the symlink is executable (chmod +x)
    And the SKILL.md contains a step between "Verify Setup" and "Provide Next Steps" that calls install-hooks

    # Confidence Scoring Guide:
    # 0.0 — No mention of hook installation in SKILL.md, no code change
    # 0.2 — SKILL.md mentions hooks in a comment or TODO but no actual step
    # 0.4 — SKILL.md has a step but it references a non-existent script or wrong path
    # 0.6 — SKILL.md has a correct step that detects git repos and calls install-hooks, but no verification
    # 0.8 — Step calls install-hooks, verifies symlink exists, handles errors
    # 1.0 — Step detects git repo, calls install-hooks, verifies symlink exists and is executable, includes rollback if install fails
    #
    # Evidence to Check:
    #   - .claude/skills/setup-harness/SKILL.md for new step between Step 10 and Step 11
    #   - grep for "install-hooks" or "pre-push" in SKILL.md
    #   - grep for "git rev-parse --git-dir" in SKILL.md (git repo detection)
    #   - Actual symlink creation logic (cli.py install-hooks subcommand)
    #
    # Red Flags:
    #   - Step says "install hooks" but doesn't actually call any script
    #   - Step hardcodes paths instead of using cli.py install-hooks
    #   - Step doesn't check if .claude/hooks/doc-gardener-pre-push.sh exists first

  Scenario: setup_harness_skips_non_git
    Given a target directory that is NOT a git repository (no .git/)
    When /setup-harness is run on this directory
    Then hook installation is skipped gracefully
    And a warning message is emitted (not an error/crash)
    And the rest of the setup-harness workflow completes normally

    # Confidence Scoring Guide:
    # 0.0 — No handling for non-git directories; script would crash
    # 0.3 — Non-git case mentioned but as a TODO or comment
    # 0.5 — git rev-parse check exists but error path is bare (no message)
    # 0.7 — Check + warning message printed, workflow continues
    # 1.0 — Check + clear warning message explaining why hooks were skipped, workflow continues, next-steps omits hook mention
    #
    # Evidence to Check:
    #   - SKILL.md step that runs git rev-parse --git-dir and checks exit code
    #   - Conditional logic: if not git repo, skip hook step
    #   - Warning text in the step description
    #
    # Red Flags:
    #   - No conditional check at all (assumes always a git repo)
    #   - Check exists but on failure the entire setup-harness aborts
    #   - The check uses [[ -d .git ]] instead of git rev-parse (fragile for worktrees)

  Scenario: setup_harness_preserves_existing_hook
    Given a target directory that already has a .git/hooks/pre-push file
    When /setup-harness is run on this directory
    Then the existing pre-push hook is NOT silently overwritten
    And the user is warned about the existing hook
    And the user is offered a choice (or the step skips with explanation)

    # Confidence Scoring Guide:
    # 0.0 — No check for existing hook; silently overwrites
    # 0.2 — Check mentioned in a comment but not implemented
    # 0.4 — Check exists but always overwrites anyway (dead code)
    # 0.6 — Check exists and skips installation if hook exists, with warning
    # 0.8 — Check + warning + offers to back up existing hook before replacing
    # 1.0 — Check + warning + backup + user choice mechanism (AskUserQuestion or similar)
    #
    # Evidence to Check:
    #   - cli.py install-hooks logic for checking existing .git/hooks/pre-push
    #   - SKILL.md step mentioning "existing hook" or "already exists"
    #   - Backup logic (e.g., cp pre-push pre-push.bak)
    #
    # Red Flags:
    #   - os.symlink() called without checking if target exists first
    #   - ln -sf (force flag) used without warning
    #   - Only checks if file exists but not if it's already the correct symlink

  Scenario: setup_harness_next_steps_updated
    Given /setup-harness has completed successfully including hook installation
    When the "Next Steps" summary is displayed (Step 11 in SKILL.md)
    Then the summary includes a line about pre-push hook installation
    And the line mentions "doc-gardener lint enforcement" or similar

    # Confidence Scoring Guide:
    # 0.0 — Next Steps section unchanged from original
    # 0.3 — Next Steps mentions hooks but generic ("hooks configured")
    # 0.6 — Next Steps specifically mentions "pre-push hook installed"
    # 0.8 — Next Steps says "pre-push hook installed (doc-gardener lint enforcement)"
    # 1.0 — Next Steps is context-aware: shows hook status if installed, shows "skipped" if non-git or existing hook conflict
    #
    # Evidence to Check:
    #   - SKILL.md Step 11 / "Next Steps" / "Provide Next Steps" section
    #   - grep for "pre-push" or "hook" in the next-steps template
    #
    # Red Flags:
    #   - Next Steps template is static (no conditional based on hook installation result)
    #   - Hook mentioned but in wrong section (not in next-steps)

Feature: F2 — Worktree-Safe Hook Symlinks
  Weight: 0.25
  Description: cli.py install-hooks creates symlinks that survive worktree removal by resolving to main working tree path, not worktree path.

  Scenario: install_hooks_resolves_to_main_tree
    Given cli.py install-hooks is invoked from within a git worktree
    When the symlink source path is constructed
    Then the path resolves to the MAIN working tree root (git rev-parse --show-toplevel of main tree)
    And the path does NOT use os.path.abspath() of the current working directory
    And the symlink target is relative or uses the main tree absolute path

    # Confidence Scoring Guide:
    # 0.0 — install-hooks still uses os.path.abspath() (unchanged from PR #11)
    # 0.2 — os.path.abspath() removed but replaced with hardcoded path
    # 0.4 — Uses git rev-parse --show-toplevel but doesn't distinguish worktree from main tree
    # 0.6 — Uses git rev-parse --show-superproject-working-tree or similar to find main tree
    # 0.8 — Correctly resolves main tree path and creates symlink pointing there; handles edge case where not in a worktree
    # 1.0 — Correct resolution with relative symlink (from .git/hooks/ to source), or absolute to main tree, plus verification step
    #
    # Evidence to Check:
    #   - .claude/scripts/attractor/cli.py install-hooks function
    #   - grep for "os.path.abspath" (should be REMOVED or replaced)
    #   - grep for "rev-parse --show-toplevel" or "rev-parse --show-superproject"
    #   - grep for "os.path.relpath" (if relative symlink approach used)
    #   - The actual os.symlink() call — check what source path is passed
    #
    # Red Flags:
    #   - os.path.abspath() still present in the symlink source path calculation
    #   - Uses os.getcwd() which resolves to worktree path
    #   - Symlink points to absolute path containing "trees/" (worktree directory)
    #   - Code only tested from main tree, not from a worktree

  Scenario: symlink_survives_worktree_removal
    Given a worktree has been created and install-hooks was run from within it
    And the symlink was created pointing to the main tree
    When the worktree is removed (git worktree remove)
    Then the .git/hooks/pre-push symlink still resolves to a valid file
    And running the pre-push hook via git push still works

    # Confidence Scoring Guide:
    # 0.0 — No consideration of worktree removal; symlink breaks
    # 0.3 — Issue acknowledged in code comments but not fixed
    # 0.5 — Symlink uses main tree path but no test verifies survival
    # 0.7 — Main tree path used AND a manual test or comment confirms survival
    # 1.0 — Main tree path used, automated test verifies create-from-worktree → remove-worktree → symlink-still-valid
    #
    # Evidence to Check:
    #   - readlink -f .git/hooks/pre-push — does the path contain "trees/" (worktree)?
    #   - Test that creates worktree, runs install-hooks, removes worktree, checks symlink
    #   - cli.py logic for path resolution
    #
    # Red Flags:
    #   - symlink target path contains worktree-specific directory names
    #   - No test exists for this specific scenario
    #   - "Works on my machine" claim without evidence of worktree testing

Feature: F3 — Example DOT File Reset
  Weight: 0.15
  Description: full-initiative.dot example file has all nodes in clean/pending state with no test pollution.

  Scenario: example_dot_all_pending
    Given the file .claude/attractor/examples/full-initiative.dot exists
    When the attractor CLI parses it for status
    Then ALL nodes show status="pending" (or have no status attribute, defaulting to pending)
    And specifically validate_backend_tech is NOT in "active" state
    And no other node has status="active", "validated", or "failed"

    # Confidence Scoring Guide:
    # 0.0 — validate_backend_tech still shows active, file unchanged
    # 0.3 — validate_backend_tech fixed but other nodes have non-pending status
    # 0.5 — All nodes are pending but the fix was done by deleting status attributes entirely (may cause parsing issues)
    # 0.7 — All nodes explicitly set to status="pending"
    # 1.0 — All nodes clean, verified by running: python3 cli.py status full-initiative.dot (all show pending)
    #
    # Evidence to Check:
    #   - .claude/attractor/examples/full-initiative.dot file content
    #   - grep for 'status="active"' or 'status="validated"' or 'status="failed"' (should be zero matches)
    #   - Run: python3 .claude/scripts/attractor/cli.py status .claude/attractor/examples/full-initiative.dot
    #
    # Red Flags:
    #   - File was modified but validate_backend_tech still has status="active"
    #   - Fix introduced new syntax errors in the DOT file
    #   - Node was deleted instead of having its status reset

Feature: F4 — cs-store-validation DX
  Weight: 0.15
  Description: cs-store-validation --help works correctly, prints usage, exits cleanly.

  Scenario: cs_store_validation_help
    Given the script .claude/scripts/completion-state/cs-store-validation exists
    When cs-store-validation --help is invoked
    Then it prints usage information describing available arguments
    And the exit code is 0
    And there is no Python traceback or "can't find '__main__' module" error

    # Confidence Scoring Guide:
    # 0.0 — Running --help still produces "can't find '__main__' module" error
    # 0.2 — Error changed but still crashes (different error message)
    # 0.4 — No crash but prints nothing useful (empty output)
    # 0.6 — Prints basic usage (script name + args list) and exits 0
    # 0.8 — Prints comprehensive help with argument descriptions and exits 0
    # 1.0 — Prints help with examples, argument descriptions, and proper exit code; no warnings
    #
    # Evidence to Check:
    #   - Run: .claude/scripts/completion-state/cs-store-validation --help
    #   - Check exit code: echo $?
    #   - Check for "usage:" or "Usage:" in output
    #   - Check script shebang line and __main__ handling
    #
    # Red Flags:
    #   - Script still uses python -m __main__ pattern incorrectly
    #   - Help output exists but script crashes on actual invocation
    #   - Fix is a wrapper script that hides the underlying error

  Scenario: cs_store_validation_no_args
    Given cs-store-validation exists and is executable
    When cs-store-validation is invoked with no arguments
    Then it prints usage information or an error message explaining required args
    And the exit code is non-zero (indicating missing required arguments)
    And there is no Python traceback

    # Confidence Scoring Guide:
    # 0.0 — No args produces Python traceback with module resolution error
    # 0.2 — No traceback but exit code is 0 (should be non-zero for missing args)
    # 0.5 — Exit code is non-zero and prints a generic error
    # 0.7 — Exit code is non-zero and prints usage showing which arguments are required
    # 1.0 — Exit code is non-zero, prints "Error: missing required arguments" followed by usage summary
    #
    # Evidence to Check:
    #   - Run: .claude/scripts/completion-state/cs-store-validation (no args)
    #   - Check exit code: echo $?
    #   - Check stderr for error message
    #   - Verify no Python traceback in output
    #
    # Red Flags:
    #   - argparse SystemExit traceback printed (ugly but technically works)
    #   - Script silently does nothing and exits 0
    #   - Error message doesn't tell user what arguments are needed

Feature: F5 — Integration Coherence
  Weight: 0.10
  Description: All changes work together: harness deployed to fresh git repo installs hooks that point to correct paths.

  Scenario: end_to_end_fresh_repo
    Given a fresh empty git repository (git init)
    When setup-harness is run against this repository (following SKILL.md workflow)
    Then .claude/ directory is populated with hooks, skills, etc.
    And .git/hooks/pre-push symlink exists
    And the symlink points to .claude/hooks/doc-gardener-pre-push.sh (or equivalent)
    And the symlink target file actually exists (not a dangling symlink)
    And the pre-push hook is executable

    # Confidence Scoring Guide:
    # 0.0 — No integration testing performed; individual fixes may conflict
    # 0.2 — Integration attempted but symlink is dangling (target doesn't exist)
    # 0.4 — Symlink exists and target exists but path is absolute to wrong location
    # 0.6 — Full integration works in main repo but not tested in fresh repo
    # 0.8 — Full integration verified in fresh repo: symlink + target + executable
    # 1.0 — Full integration verified, including: fresh git init → setup-harness → symlink valid → pre-push runs without error
    #
    # Evidence to Check:
    #   - End-to-end test: mkdir /tmp/test-repo && cd /tmp/test-repo && git init && [run setup-harness]
    #   - readlink .git/hooks/pre-push — does it resolve?
    #   - ls -la .git/hooks/pre-push — is it executable?
    #   - .git/hooks/pre-push 2>&1 — does it run without error?
    #
    # Red Flags:
    #   - Integration only tested on existing repos, not fresh ones
    #   - symlink works from the harness repo but breaks when copied to target
    #   - pre-push hook fails because it can't find doc-gardener scripts
    #   - The E2E test was done mentally ("should work") without running it
