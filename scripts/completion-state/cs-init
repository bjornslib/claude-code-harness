#!/bin/bash
# cs-init - Initialize completion state and generate session ID
#
# Usage:
#   eval "$(cs-init)"              # Initialize and export CLAUDE_SESSION_ID
#   cs-init --show                 # Show current session ID without generating
#   cs-init --check-orphans        # Check for orphaned in_progress promises
#
# The new architecture:
#   - Promises are stored in .claude/completion-state/promises/{uuid}.json
#   - Each promise tracks its owner session and status
#   - Multiple sessions can run in parallel, each owning different promises
#   - Session ID format: {timestamp}-{random8} (e.g., 20260110T142532Z-a7f3b9e1)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STATE_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/completion-state"
PROMISES_DIR="$STATE_DIR/promises"
HISTORY_DIR="$STATE_DIR/history"

MODE="init"

while [[ $# -gt 0 ]]; do
    case $1 in
        --show)
            MODE="show"
            shift
            ;;
        --check-orphans)
            MODE="check-orphans"
            shift
            ;;
        --initiative)
            INITIATIVE="$2"
            shift 2
            ;;
        --help)
            echo "Usage:"
            echo "  eval \"\$(cs-init)\"                          # Initialize with timestamp only"
            echo "  eval \"\$(cs-init --initiative <name>)\"      # Initialize with initiative name"
            echo "  cs-init --show                              # Show current session ID"
            echo "  cs-init --check-orphans                     # Check for orphaned promises"
            echo ""
            echo "Initializes the completion state system and generates a unique session ID."
            echo "The session ID is used to track promise ownership across parallel sessions."
            echo ""
            echo "Options:"
            echo "  --initiative <name>   Include initiative name in session directory"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

case $MODE in
    show)
        if [ -n "$CLAUDE_SESSION_ID" ]; then
            echo "Current session: $CLAUDE_SESSION_ID"
        else
            echo "No CLAUDE_SESSION_ID set. Run: eval \"\$(cs-init)\"" >&2
            exit 1
        fi
        ;;

    check-orphans)
        if [ ! -d "$PROMISES_DIR" ]; then
            echo "No promises directory found."
            exit 0
        fi

        echo "Checking for orphaned in_progress promises..."
        ORPHANS=0
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            STATUS=$(jq -r '.status // "unknown"' "$f")
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            if [ "$STATUS" = "in_progress" ] && [ "$OWNER" = "null" ]; then
                ID=$(jq -r '.id' "$f")
                SUMMARY=$(jq -r '.summary // ""' "$f" | head -c 50)
                echo "  [ORPHANED] $ID: $SUMMARY..."
                ORPHANS=$((ORPHANS + 1))
            fi
        done

        if [ $ORPHANS -eq 0 ]; then
            echo "No orphaned promises found."
        else
            echo ""
            echo "Found $ORPHANS orphaned promise(s). Use 'cs-promise --adopt <id>' to claim."
        fi
        ;;

    init)
        # Create directories
        mkdir -p "$STATE_DIR/sessions"
        mkdir -p "$PROMISES_DIR"
        mkdir -p "$HISTORY_DIR"

        # Generate session ID if not set
        if [ -z "$CLAUDE_SESSION_ID" ]; then
            SESSION_ID=$("$SCRIPT_DIR/generate-session-id")
        else
            SESSION_ID="$CLAUDE_SESSION_ID"
        fi

        # Create session directory name
        if [ -n "$INITIATIVE" ]; then
            SESSION_DIR_NAME="session-$(date +%Y%m%d-%H%M%S)-$INITIATIVE"
        else
            SESSION_DIR_NAME="session-$(date +%Y%m%d-%H%M%S)"
        fi

        SESSION_PATH="$STATE_DIR/sessions/$SESSION_DIR_NAME"
        mkdir -p "$SESSION_PATH"

        # Create session-state.json in the new directory
        if [ ! -f "$SESSION_PATH/session-state.json" ]; then
            cat > "$SESSION_PATH/session-state.json" <<EOF
{
    "version": "1.0",
    "session_id": "$SESSION_ID",
    "initiative": ${INITIATIVE:+\"$INITIATIVE\"}${INITIATIVE:-null},
    "started_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "iteration": 1,
    "max_iterations": 25,
    "completion_promise": {
        "raw_prompt": null,
        "summary": null,
        "extracted_at": null
    },
    "goals": [],
    "prd": {
        "source": null,
        "epics": []
    },
    "progress_log": [],
    "codebase_patterns": []
}
EOF
        fi

        # Update symlink for backward compat
        rm -f "$STATE_DIR/session-state.json"
        ln -s "sessions/$SESSION_DIR_NAME/session-state.json" "$STATE_DIR/session-state.json"

        # Output export commands
        echo "export CLAUDE_SESSION_ID=\"$SESSION_ID\""
        echo "export CLAUDE_SESSION_DIR=\"$SESSION_PATH\""

        echo "# Initialized session: $SESSION_ID" >&2
        echo "# Session dir: $SESSION_PATH" >&2
        ;;
esac
