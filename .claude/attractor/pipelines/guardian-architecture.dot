digraph "PRD-S3-GUARDIAN-001" {
    graph [
        label="Initiative: PRD-S3-GUARDIAN-001"
        labelloc="t"
        fontsize=16
        rankdir="TB"
        prd_ref="PRD-S3-GUARDIAN-001"
        promise_id=""
    ];

    node [fontname="Helvetica" fontsize=11];
    edge [fontname="Helvetica" fontsize=9];

    // ===== STAGE 1: PARSE =====

    start [
        shape=Mdiamond
        label="PARSE\nPRD-S3-GUARDIAN-001"
        handler="start"
        status="validated"
        style=filled
        fillcolor=lightgreen
    ];

    // ===== STAGE 2: VALIDATE =====

    validate_graph [
        shape=box
        label="Validate Graph\nStructure"
        handler="tool"
        command="attractor validate pipeline.dot"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    start -> validate_graph [label="parse complete"];

    // ===== STAGE 3: INITIALIZE =====

    init_env [
        shape=box
        label="Initialize\nEnvironment"
        handler="tool"
        command="launchorchestrator prd-s3-guardian-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_graph -> init_env [label="graph valid"];

    // ===== STAGE 4: EXECUTE =====

    // --- Parallel fan-out ---

    parallel_start [
        shape=parallelogram
        label="Parallel:\nEpic 3: Headless\nGuardian Agent\n(Layer 1) - pipeline + Epic 2: Runner Agent\n(Layer 2) - tmux\nmonitor + Guardian + Epic 4: DOT Schema\nExtensions (prd_ref,\nprd_section, +3 more"
        handler="parallel"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    init_env -> parallel_start [label="env ready"];

    // --- Task: Epic 3: Headless Guardian Agent (Layer 1) - pipeline executi ---

    impl_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine [
        shape=box
        label="Epic 3: Headless Guardian Agent (Layer\n1) - pipeline execution engine"
        handler="codergen"
        bead_id="claude-harness-setup-9wfe"
        worker_type="frontend-dev-expert"
        acceptance="Guardian reads DOT and identifies ready nodes. Spawns Runner for codergen nodes via Agent SDK. Handles all Runner signal"
        promise_ac="AC-1"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine [color=blue style=bold];

    validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_tech [
        shape=hexagon
        label="Epic 3:\nHeadless\nGuardian Agent\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-n_9wfe-TECH"
        promise_ac="AC-1"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine -> validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_tech [label="impl_complete"];

    validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_biz [
        shape=hexagon
        label="Epic 3:\nHeadless\nGuardian Agent\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-n_9wfe-BIZ"
        promise_ac="AC-1"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_tech -> validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_biz [label="tech pass"];

    decision_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine [
        shape=diamond
        label="Epic 3:\nHeadless\nGuardian Agent\nResult?"
        handler="conditional"
    ];

    validate_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine_biz -> decision_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine;

    decision_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine -> impl_epic_3_headless_guardian_agent_layer_1_pipeline_execution_engine [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: Epic 2: Runner Agent (Layer 2) - tmux monitor + Guardian sig ---

    impl_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler [
        shape=box
        label="Epic 2: Runner Agent (Layer 2) - tmux\nmonitor + Guardian signaler"
        handler="codergen"
        bead_id="claude-harness-setup-ja7d"
        worker_type="frontend-dev-expert"
        acceptance="- Runner spawns via Agent SDK with CLI tools\n- Detects orchestrator completion, errors, input requests, stuck states\n-"
        promise_ac="AC-2"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler [color=blue style=bold];

    validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_tech [
        shape=hexagon
        label="Epic 2: Runner\nAgent (Layer 2)\n- tmux monitor\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-ja7d-TECH"
        promise_ac="AC-2"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler -> validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_tech [label="impl_complete"];

    validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_biz [
        shape=hexagon
        label="Epic 2: Runner\nAgent (Layer 2)\n- tmux monitor\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-ja7d-BIZ"
        promise_ac="AC-2"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_tech -> validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_biz [label="tech pass"];

    decision_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler [
        shape=diamond
        label="Epic 2: Runner\nAgent (Layer 2)\n- tmux monitor\nResult?"
        handler="conditional"
    ];

    validate_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler_biz -> decision_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler;

    decision_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler -> impl_epic_2_runner_agent_layer_2_tmux_monitor_guardian_signaler [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: Epic 4: DOT Schema Extensions (prd_ref, prd_section, solutio ---

    impl_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir [
        shape=box
        label="Epic 4: DOT Schema Extensions (prd_ref,\nprd_section, solution_design,\ntarget_dir)"
        handler="codergen"
        bead_id="claude-harness-setup-ntot"
        worker_type="solution-architect"
        acceptance="- parser.py extracts all new attributes\n- validator.py enforces prd_ref on codergen nodes\n- cli.py node add/modify sup"
        promise_ac="AC-3"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir [color=blue style=bold];

    validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_tech [
        shape=hexagon
        label="Epic 4: DOT\nSchema\nExtensions\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-ntot-TECH"
        promise_ac="AC-3"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir -> validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_tech [label="impl_complete"];

    validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_biz [
        shape=hexagon
        label="Epic 4: DOT\nSchema\nExtensions\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-ntot-BIZ"
        promise_ac="AC-3"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_tech -> validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_biz [label="tech pass"];

    decision_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir [
        shape=diamond
        label="Epic 4: DOT\nSchema\nExtensions\nResult?"
        handler="conditional"
    ];

    validate_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir_biz -> decision_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir;

    decision_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir -> impl_epic_4_dot_schema_extensions_prd_ref_prd_section_solution_design_target_dir [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: Epic 1: Signal Protocol Foundation and Core CLI Tools ---

    impl_epic_1_signal_protocol_foundation_and_core_cli_tools [
        shape=box
        label="Epic 1: Signal Protocol Foundation and\nCore CLI Tools"
        handler="codergen"
        bead_id="claude-harness-setup-nri3"
        worker_type="backend-solutions-engineer"
        acceptance="- Signal files written atomically (no partial reads)\n- All CLI tools return valid JSON and support --help\n- Unit tests"
        promise_ac="AC-4"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_1_signal_protocol_foundation_and_core_cli_tools [color=blue style=bold];

    validate_epic_1_signal_protocol_foundation_and_core_cli_tools_tech [
        shape=hexagon
        label="Epic 1: Signal\nProtocol\nFoundation and\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-nri3-TECH"
        promise_ac="AC-4"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_1_signal_protocol_foundation_and_core_cli_tools -> validate_epic_1_signal_protocol_foundation_and_core_cli_tools_tech [label="impl_complete"];

    validate_epic_1_signal_protocol_foundation_and_core_cli_tools_biz [
        shape=hexagon
        label="Epic 1: Signal\nProtocol\nFoundation and\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-nri3-BIZ"
        promise_ac="AC-4"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_1_signal_protocol_foundation_and_core_cli_tools_tech -> validate_epic_1_signal_protocol_foundation_and_core_cli_tools_biz [label="tech pass"];

    decision_epic_1_signal_protocol_foundation_and_core_cli_tools [
        shape=diamond
        label="Epic 1: Signal\nProtocol\nFoundation and\nResult?"
        handler="conditional"
    ];

    validate_epic_1_signal_protocol_foundation_and_core_cli_tools_biz -> decision_epic_1_signal_protocol_foundation_and_core_cli_tools;

    decision_epic_1_signal_protocol_foundation_and_core_cli_tools -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_1_signal_protocol_foundation_and_core_cli_tools -> impl_epic_1_signal_protocol_foundation_and_core_cli_tools [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: Epic 6: E2E Integration Test Suite ---

    impl_epic_6_e2e_integration_test_suite [
        shape=box
        label="Epic 6: E2E Integration Test Suite"
        handler="codergen"
        bead_id="claude-harness-setup-kyfa"
        worker_type="tdd-test-engineer"
        acceptance="E2E test covers single-node pipeline (Guardian->Runner->Orchestrator->validate). Signal flow logged with timestamps. All"
        promise_ac="AC-5"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_6_e2e_integration_test_suite [color=blue style=bold];

    validate_epic_6_e2e_integration_test_suite_tech [
        shape=hexagon
        label="Epic 6: E2E\nIntegration\nTest Suite\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-kyfa-TECH"
        promise_ac="AC-5"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_6_e2e_integration_test_suite -> validate_epic_6_e2e_integration_test_suite_tech [label="impl_complete"];

    validate_epic_6_e2e_integration_test_suite_biz [
        shape=hexagon
        label="Epic 6: E2E\nIntegration\nTest Suite\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-kyfa-BIZ"
        promise_ac="AC-5"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_6_e2e_integration_test_suite_tech -> validate_epic_6_e2e_integration_test_suite_biz [label="tech pass"];

    decision_epic_6_e2e_integration_test_suite [
        shape=diamond
        label="Epic 6: E2E\nIntegration\nTest Suite\nResult?"
        handler="conditional"
    ];

    validate_epic_6_e2e_integration_test_suite_biz -> decision_epic_6_e2e_integration_test_suite;

    decision_epic_6_e2e_integration_test_suite -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_6_e2e_integration_test_suite -> impl_epic_6_e2e_integration_test_suite [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: Epic 5: Interactive Terminal Integration (Layer 0) ---

    impl_epic_5_interactive_terminal_integration_layer_0 [
        shape=box
        label="Epic 5: Interactive Terminal Integration\n(Layer 0)"
        handler="codergen"
        bead_id="claude-harness-setup-maah"
        worker_type="backend-solutions-engineer"
        acceptance="launch_guardian.py constructs Agent SDK call with env -u CLAUDECODE. Terminal detects Guardian subprocess exit and resta"
        promise_ac="AC-6"
        prd_ref="PRD-S3-GUARDIAN-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    parallel_start -> impl_epic_5_interactive_terminal_integration_layer_0 [color=blue style=bold];

    validate_epic_5_interactive_terminal_integration_layer_0_tech [
        shape=hexagon
        label="Epic 5:\nInteractive\nTerminal\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-maah-TECH"
        promise_ac="AC-6"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    impl_epic_5_interactive_terminal_integration_layer_0 -> validate_epic_5_interactive_terminal_integration_layer_0_tech [label="impl_complete"];

    validate_epic_5_interactive_terminal_integration_layer_0_biz [
        shape=hexagon
        label="Epic 5:\nInteractive\nTerminal\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-maah-BIZ"
        promise_ac="AC-6"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    validate_epic_5_interactive_terminal_integration_layer_0_tech -> validate_epic_5_interactive_terminal_integration_layer_0_biz [label="tech pass"];

    decision_epic_5_interactive_terminal_integration_layer_0 [
        shape=diamond
        label="Epic 5:\nInteractive\nTerminal\nResult?"
        handler="conditional"
    ];

    validate_epic_5_interactive_terminal_integration_layer_0_biz -> decision_epic_5_interactive_terminal_integration_layer_0;

    decision_epic_5_interactive_terminal_integration_layer_0 -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_epic_5_interactive_terminal_integration_layer_0 -> impl_epic_5_interactive_terminal_integration_layer_0 [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Parallel fan-in ---

    join_validation [
        shape=parallelogram
        label="Join:\nAll Streams\nValidated"
        handler="parallel"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];

    join_validation -> finalize [label="all pass" style=bold];

    // ===== STAGE 5: FINALIZE =====

    finalize [
        shape=Msquare
        label="FINALIZE\nTriple Gate\ncs-verify"
        handler="exit"
        promise_id=""
        promise_ac="AC-6"
        status="pending"
        style=filled
        fillcolor=lightyellow
    ];
}
