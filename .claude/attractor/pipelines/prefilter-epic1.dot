digraph "PRD-PREFILTER-001" {
    graph [
        label="Initiative: PRD-PREFILTER-001"
        labelloc="t"
        fontsize=16
        rankdir="TB"
        prd_ref="PRD-PREFILTER-001"
        promise_id=""
        target_dir="/Users/theb/Documents/Windsurf/DSPY_PreEmploymentDirectory_PoC"
    ];

    node [fontname="Helvetica" fontsize=11];
    edge [fontname="Helvetica" fontsize=9];

    // ===== STAGE 1: PARSE =====

    start [
        shape=Mdiamond
        label="PARSE\nPRD-PREFILTER-001"
        handler="start"
        status="validated"
        style=filled
        fillcolor=lightgreen
    ];

    // ===== STAGE 2: VALIDATE =====

    validate_graph [
        shape=box
        label="Validate Graph\nStructure"
        handler="tool"
        command="attractor validate pipeline.dot"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    start -> validate_graph [label="parse complete"];

    // ===== STAGE 3: INITIALIZE =====

    init_env [
        shape=box
        label="Initialize\nEnvironment"
        handler="tool"
        command="launchorchestrator prd-prefilter-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_graph -> init_env [label="graph valid"];

    // ===== STAGE 4: EXECUTE =====

    // --- Parallel fan-out ---

    parallel_start [
        shape=parallelogram
        label="Parallel:\nPRD-PREFILTER-001:\nWire\nfilter_relevant_only() + PRD-PREFILTER-001\nEpic 1: CLI Pipeline\nIntegration + PRD-PREFILTER-001:\nCreate\ntest_prefilter_integration.py +3 more"
        handler="parallel"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    init_env -> parallel_start [label="env ready"];

    // --- Task: PRD-PREFILTER-001: Wire filter_relevant_only() into ingest p ---

    impl_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline [
        shape=box
        label="PRD-PREFILTER-001: Wire\nfilter_relevant_only() into ingest\npipeline"
        handler="codergen"
        bead_id="claude-harness-setup-rxrz"
        worker_type="backend-solutions-engineer"
        promise_ac="AC-1"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="In newsletter-agents/cli.py ingest() command, call prefilter.filter_relevant_only() on unvetted articles with threshold=0.6 between ingest_from_feeds() and the store loop. Recombine trusted + filtered before storing."
    ];

    parallel_start -> impl_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline [color=blue style=bold];

    validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_tech [
        shape=hexagon
        label="PRD-PREFILTER-001:\nWire\nfilter_relevant_only()\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-rxrz-TECH"
        promise_ac="AC-1"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline -> validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_tech [label="impl_complete"];

    validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_biz [
        shape=hexagon
        label="PRD-PREFILTER-001:\nWire\nfilter_relevant_only()\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-rxrz-BIZ"
        promise_ac="AC-1"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_tech -> validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_biz [label="tech pass"];

    decision_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline [
        shape=diamond
        label="PRD-PREFILTER-001:\nWire\nfilter_relevant_only()\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline_biz -> decision_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline;

    decision_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline -> impl_prd_prefilter_001_wire_filter_relevant_only_into_ingest_pipeline [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: PRD-PREFILTER-001 Epic 1: CLI Pipeline Integration ---

    impl_prd_prefilter_001_epic_1_cli_pipeline_integration [
        shape=box
        label="PRD-PREFILTER-001 Epic 1: CLI Pipeline\nIntegration"
        handler="codergen"
        bead_id="claude-harness-setup-wl3r"
        worker_type="backend-solutions-engineer"
        promise_ac="AC-2"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="Full Epic 1 integration: _split_by_trust() separates NAPBS/SHRM/FCRA.com trusted sources, filter_relevant_only() filters unvetted articles, stats panel displays passed/filtered/pass_rate, --no-prefilter flag works, zero existing test failures."
    ];

    parallel_start -> impl_prd_prefilter_001_epic_1_cli_pipeline_integration [color=blue style=bold];

    validate_prd_prefilter_001_epic_1_cli_pipeline_integration_tech [
        shape=hexagon
        label="PRD-PREFILTER-001\nEpic 1: CLI\nPipeline\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-wl3r-TECH"
        promise_ac="AC-2"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_epic_1_cli_pipeline_integration -> validate_prd_prefilter_001_epic_1_cli_pipeline_integration_tech [label="impl_complete"];

    validate_prd_prefilter_001_epic_1_cli_pipeline_integration_biz [
        shape=hexagon
        label="PRD-PREFILTER-001\nEpic 1: CLI\nPipeline\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-wl3r-BIZ"
        promise_ac="AC-2"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_epic_1_cli_pipeline_integration_tech -> validate_prd_prefilter_001_epic_1_cli_pipeline_integration_biz [label="tech pass"];

    decision_prd_prefilter_001_epic_1_cli_pipeline_integration [
        shape=diamond
        label="PRD-PREFILTER-001\nEpic 1: CLI\nPipeline\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_epic_1_cli_pipeline_integration_biz -> decision_prd_prefilter_001_epic_1_cli_pipeline_integration;

    decision_prd_prefilter_001_epic_1_cli_pipeline_integration -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_epic_1_cli_pipeline_integration -> impl_prd_prefilter_001_epic_1_cli_pipeline_integration [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: PRD-PREFILTER-001: Create test_prefilter_integration.py ---

    impl_prd_prefilter_001_create_test_prefilter_integration_py [
        shape=box
        label="PRD-PREFILTER-001: Create\ntest_prefilter_integration.py"
        handler="codergen"
        bead_id="claude-harness-setup-s46u"
        worker_type="tdd-test-engineer"
        promise_ac="AC-3"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="Create newsletter-agents/tests/test_prefilter_integration.py with unit tests for _split_by_trust(), apply_prefilter wrapper, trusted bypass, stats display, --no-prefilter flag, and E2E ingest-with-prefilter integration test. All tests must pass with pytest."
    ];

    parallel_start -> impl_prd_prefilter_001_create_test_prefilter_integration_py [color=blue style=bold];

    validate_prd_prefilter_001_create_test_prefilter_integration_py_tech [
        shape=hexagon
        label="PRD-PREFILTER-001:\nCreate\ntest_prefilter_integration.py\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-s46u-TECH"
        promise_ac="AC-3"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_create_test_prefilter_integration_py -> validate_prd_prefilter_001_create_test_prefilter_integration_py_tech [label="impl_complete"];

    validate_prd_prefilter_001_create_test_prefilter_integration_py_biz [
        shape=hexagon
        label="PRD-PREFILTER-001:\nCreate\ntest_prefilter_integration.py\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-s46u-BIZ"
        promise_ac="AC-3"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_create_test_prefilter_integration_py_tech -> validate_prd_prefilter_001_create_test_prefilter_integration_py_biz [label="tech pass"];

    decision_prd_prefilter_001_create_test_prefilter_integration_py [
        shape=diamond
        label="PRD-PREFILTER-001:\nCreate\ntest_prefilter_integration.py\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_create_test_prefilter_integration_py_biz -> decision_prd_prefilter_001_create_test_prefilter_integration_py;

    decision_prd_prefilter_001_create_test_prefilter_integration_py -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_create_test_prefilter_integration_py -> impl_prd_prefilter_001_create_test_prefilter_integration_py [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: PRD-PREFILTER-001: Add pre-filter statistics Panel display ---

    impl_prd_prefilter_001_add_pre_filter_statistics_panel_display [
        shape=box
        label="PRD-PREFILTER-001: Add pre-filter\nstatistics Panel display"
        handler="codergen"
        bead_id="claude-harness-setup-7dyg"
        worker_type="backend-solutions-engineer"
        promise_ac="AC-4"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="Add Rich Panel in cli.py showing pre-filter stats: passed count (green), filtered count (red), pass_rate percentage, avg_score, and trusted source bypass count (cyan). Use prefilter.get_prefilter_stats() for data."
    ];

    parallel_start -> impl_prd_prefilter_001_add_pre_filter_statistics_panel_display [color=blue style=bold];

    validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_tech [
        shape=hexagon
        label="PRD-PREFILTER-001:\nAdd pre-filter\nstatistics\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-n_7dyg-TECH"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_add_pre_filter_statistics_panel_display -> validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_tech [label="impl_complete"];

    validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_biz [
        shape=hexagon
        label="PRD-PREFILTER-001:\nAdd pre-filter\nstatistics\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-n_7dyg-BIZ"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_tech -> validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_biz [label="tech pass"];

    decision_prd_prefilter_001_add_pre_filter_statistics_panel_display [
        shape=diamond
        label="PRD-PREFILTER-001:\nAdd pre-filter\nstatistics\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_add_pre_filter_statistics_panel_display_biz -> decision_prd_prefilter_001_add_pre_filter_statistics_panel_display;

    decision_prd_prefilter_001_add_pre_filter_statistics_panel_display -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_add_pre_filter_statistics_panel_display -> impl_prd_prefilter_001_add_pre_filter_statistics_panel_display [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: PRD-PREFILTER-001: Implement _split_by_trust() trusted sourc ---

    impl_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass [
        shape=box
        label="PRD-PREFILTER-001: Implement\n_split_by_trust() trusted source bypass"
        handler="codergen"
        bead_id="claude-harness-setup-75ya"
        worker_type="backend-solutions-engineer"
        promise_ac="AC-5"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="Create _split_by_trust(articles) function that returns (trusted, unvetted) where trusted articles have source_url matching NAPBS/SHRM/FCRA.com. TRUSTED_SOURCES = {"napbs.com", "shrm.org", "fcra.com"}. Trusted articles must bypass filtering entirely."
    ];

    parallel_start -> impl_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass [color=blue style=bold];

    validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_tech [
        shape=hexagon
        label="PRD-PREFILTER-001:\nImplement\n_split_by_trust()\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-n_75ya-TECH"
        promise_ac="AC-5"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass -> validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_tech [label="impl_complete"];

    validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_biz [
        shape=hexagon
        label="PRD-PREFILTER-001:\nImplement\n_split_by_trust()\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-n_75ya-BIZ"
        promise_ac="AC-5"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_tech -> validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_biz [label="tech pass"];

    decision_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass [
        shape=diamond
        label="PRD-PREFILTER-001:\nImplement\n_split_by_trust()\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass_biz -> decision_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass;

    decision_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass -> impl_prd_prefilter_001_implement_split_by_trust_trusted_source_bypass [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Task: PRD-PREFILTER-001: Add --no-prefilter CLI flag ---

    impl_prd_prefilter_001_add_no_prefilter_cli_flag [
        shape=box
        label="PRD-PREFILTER-001: Add --no-prefilter\nCLI flag"
        handler="codergen"
        bead_id="claude-harness-setup-h87k"
        worker_type="backend-solutions-engineer"
        promise_ac="AC-6"
        prd_ref="PRD-PREFILTER-001"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    
        acceptance="Add --no-prefilter boolean CLI flag to the ingest() command that bypasses all filtering when set. When True, all articles pass directly to the store loop without _split_by_trust or filter_relevant_only processing."
    ];

    parallel_start -> impl_prd_prefilter_001_add_no_prefilter_cli_flag [color=blue style=bold];

    validate_prd_prefilter_001_add_no_prefilter_cli_flag_tech [
        shape=hexagon
        label="PRD-PREFILTER-001:\nAdd\n--no-prefilter\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-h87k-TECH"
        promise_ac="AC-6"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    impl_prd_prefilter_001_add_no_prefilter_cli_flag -> validate_prd_prefilter_001_add_no_prefilter_cli_flag_tech [label="impl_complete"];

    validate_prd_prefilter_001_add_no_prefilter_cli_flag_biz [
        shape=hexagon
        label="PRD-PREFILTER-001:\nAdd\n--no-prefilter\nBusiness\nValidation"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-h87k-BIZ"
        promise_ac="AC-6"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_prd_prefilter_001_add_no_prefilter_cli_flag_tech -> validate_prd_prefilter_001_add_no_prefilter_cli_flag_biz [label="tech pass"];

    decision_prd_prefilter_001_add_no_prefilter_cli_flag [
        shape=diamond
        label="PRD-PREFILTER-001:\nAdd\n--no-prefilter\nResult?"
        handler="conditional"
    
        status="validated"
    
        fillcolor="lightgreen"
    
        style="filled"
    ];

    validate_prd_prefilter_001_add_no_prefilter_cli_flag_biz -> decision_prd_prefilter_001_add_no_prefilter_cli_flag;

    decision_prd_prefilter_001_add_no_prefilter_cli_flag -> join_validation [
        label="pass"
        condition="pass"
        color=green
    ];
    decision_prd_prefilter_001_add_no_prefilter_cli_flag -> impl_prd_prefilter_001_add_no_prefilter_cli_flag [
        label="fail\nretry"
        condition="fail"
        color=red
        style=dashed
    ];

    // --- Parallel fan-in ---

    join_validation [
        shape=parallelogram
        label="Join:\nAll Streams\nValidated"
        handler="parallel"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    join_validation -> finalize [label="all pass" style=bold];

    // ===== STAGE 5: FINALIZE =====

    finalize [
        shape=Msquare
        label="FINALIZE\nTriple Gate\ncs-verify"
        handler="exit"
        promise_id=""
        promise_ac="AC-6"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];
}
