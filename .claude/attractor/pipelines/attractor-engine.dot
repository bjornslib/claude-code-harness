digraph "PRD-S3-ATTRACTOR-002" {
    graph [
        label="Initiative: PRD-S3-ATTRACTOR-002 — Attractor Pipeline Execution Engine"
        labelloc="t"
        fontsize=16
        rankdir="TB"
        prd_ref="PRD-S3-ATTRACTOR-002"
        promise_id="promise-aef3bde8"
        auto_pair_at="true"
    ];

    node [fontname="Helvetica" fontsize=11];
    edge [fontname="Helvetica" fontsize=9];

    // ===== SENTINELS =====

    start [
        shape=Mdiamond
        label="START\nPRD-S3-ATTRACTOR-002"
        handler="start"
        status="validated"
        style=filled
        fillcolor=lightgreen
    ];

    finalize [
        shape=Msquare
        label="FINALIZE\nTriple Gate\ncs-verify"
        handler="exit"
        promise_id="promise-aef3bde8"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    // ===== EPIC 1: Pipeline Runner Agent (Agent SDK) =====
    // Must complete first — foundation for all other epics

    epic1_runner [
        shape=box
        label="Epic 1:\nPipeline Runner\nAgent (SDK)"
        handler="codergen"
        bead_id="claude-harness-setup-9sxe"
        worker_type="backend-solutions-engineer"
        status="validated"
        acceptance="9 tools implemented (read_pipeline_status, evaluate_node_readiness, transition_node, save_checkpoint, propose_spawn_worker, collect_validation_result, signal_finalize, report_progress, request_human_input). RunnerPlan typed output. Crash-resilient checkpoint.json. All POC scenarios pass with full runner."
        promise_ac="AC-1"
        style=filled
        fillcolor="lightgreen"
    ];

    AT_epic1 [
        shape=hexagon
        label="Validate\nEpic 1"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-EPIC1-TECH"
        acceptance="All 9 tools functional. RunnerPlan schema validated. POC test scenarios pass with full runner."
        files=".claude/scripts/attractor/pipeline_runner.py,.claude/scripts/attractor/runner_tools.py,.claude/scripts/attractor/runner_plan.py"
        promise_ac="AC-1"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    // ===== EPIC 2: Channel Bridge + GChat Adapter =====
    // Depends on Epic 1 (runner must exist for bridge to invoke)

    epic2_channel [
        shape=box
        label="Epic 2:\nHybrid Channel\nBridge"
        handler="codergen"
        bead_id="claude-harness-setup-jaxb"
        worker_type="backend-solutions-engineer"
        status="validated"
        acceptance="Hybrid channel bridge: ChannelAdapter ABC with LocalHooksAdapter (primary, wraps gchat-send.sh + gchat-poll-replies.py) and WebhookAdapter stub (future Tailscale Funnel). InboundMessage/OutboundMessage Pydantic models. Intent parser (approve/reject/status/help). Card formatting. Adapter registry with factory."
        promise_ac="AC-2"
        style=filled
        fillcolor="lightgreen"
    ];

    AT_epic2 [
        shape=hexagon
        label="Validate\nEpic 2"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-EPIC2-TECH"
        acceptance="LocalHooksAdapter wraps gchat-send.sh and gchat-poll-replies.py. WebhookAdapter stub exists with Tailscale Funnel config placeholder. Intent parser classifies approve/reject/status/help. Card formatting produces pipeline status reports. Adapter registry loads correct adapter by config."
        files=".claude/scripts/attractor/channel_bridge.py,.claude/scripts/attractor/adapters/gchat_adapter.py,.claude/scripts/attractor/channel_intents.py,.claude/scripts/attractor/channel_cards.py"
        promise_ac="AC-2"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    // ===== EPIC 3: Guard Rails + Anti-Gaming =====
    // Parallel with Epic 2, depends on Epic 1

    epic3_guardrails [
        shape=box
        label="Epic 3:\nGuard Rails\n+ Anti-Gaming"
        handler="codergen"
        bead_id="claude-harness-setup-7zev"
        worker_type="backend-solutions-engineer"
        status="validated"
        acceptance="PreToolUse hooks block Edit/Write on validation agents. Implementer-validator separation enforced. Evidence timestamping on all validation records. Max 3 retry limit with audit trail. Anti-gaming: blind validation, no self-grading."
        promise_ac="AC-3"
        style=filled
        fillcolor="lightgreen"
    ];

    AT_epic3 [
        shape=hexagon
        label="Validate\nEpic 3"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-EPIC3-TECH"
        acceptance="Hook blocks Edit/Write for validation role. Implementer cannot validate own work. Evidence includes ISO timestamps. Retry counter enforced at 3. Audit trail records all transitions."
        files=".claude/scripts/attractor/runner_hooks.py,.claude/scripts/attractor/anti_gaming.py"
        promise_ac="AC-3"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    // ===== EPIC 5: System 3 + Guardian Integration =====
    // Depends on ALL of Epics 1, 2, 3

    epic5_integration [
        shape=box
        label="Epic 5:\nS3 + Guardian\nIntegration"
        handler="codergen"
        bead_id="claude-harness-setup-gp49"
        worker_type="backend-solutions-engineer"
        status="validated"
        acceptance="S3 output-style references runner spawn pattern. Guardian SKILL.md updated with DOT-based validation using runner. S3 can spawn runner via Agent SDK for new initiatives. Guardian reads pipeline state via read-only tools."
        promise_ac="AC-4"
        style=filled
        fillcolor="lightgreen"
    ];

    AT_epic5 [
        shape=hexagon
        label="Validate\nEpic 5"
        handler="wait.human"
        gate="business"
        mode="business"
        bead_id="AT-EPIC5-BIZ"
        acceptance="S3 meta-orchestrator can spawn pipeline runner for a new initiative. Guardian can independently validate pipeline state. Full workflow: S3 spawns runner -> runner executes pipeline -> channel bridge reports to GChat -> guardian validates."
        files=".claude/output-styles/system3-meta-orchestrator.md,.claude/skills/s3-guardian/SKILL.md,.claude/skills/system3-orchestrator/SKILL.md"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    // ===== EDGES: Dependency Chain =====

    // Epic 1 starts from start
    start -> epic1_runner [label="begin"];

    // Epic 1 -> validation gate
    epic1_runner -> AT_epic1 [label="impl_complete" condition="pass"];

    // Epic 2 and 3 start after Epic 1 validates (parallel)
    AT_epic1 -> epic2_channel [label="pass" condition="pass"];
    AT_epic1 -> epic3_guardrails [label="pass" condition="pass"];

    // Epic 2 -> validation
    epic2_channel -> AT_epic2 [label="impl_complete" condition="pass"];

    // Epic 3 -> validation
    epic3_guardrails -> AT_epic3 [label="impl_complete" condition="pass"];

    // Epic 5 starts after BOTH Epic 2 and 3 validate
    AT_epic2 -> epic5_integration [label="pass" condition="pass"];
    AT_epic3 -> epic5_integration [label="pass" condition="pass"];

    // Epic 5 -> validation
    epic5_integration -> AT_epic5 [label="impl_complete" condition="pass"];

    // Final gate
    AT_epic5 -> finalize [label="pass" condition="pass"];

    // Failure edges
    AT_epic1 -> finalize [label="fail" condition="fail" style="dashed"];
    AT_epic2 -> finalize [label="fail" condition="fail" style="dashed"];
    AT_epic3 -> finalize [label="fail" condition="fail" style="dashed"];
    AT_epic5 -> finalize [label="fail" condition="fail" style="dashed"];
}
