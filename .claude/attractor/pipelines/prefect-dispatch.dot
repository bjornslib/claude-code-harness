digraph "PRD-PREFECT-DISPATCH-001" {
    graph [
        label="Initiative: PRD-PREFECT-DISPATCH-001\nPrefect Dispatch Pipeline"
        labelloc="t"
        fontsize=16
        rankdir="TB"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        promise_id="promise-0bef990d"
        target_dir="/Users/theb/Documents/Windsurf/zenagent2/zenagent/agencheck/agencheck-support-agent"
    ];

    node [fontname="Helvetica" fontsize=11];
    edge [fontname="Helvetica" fontsize=9];

    // ===== ENTRY =====

    start [
        shape=Mdiamond
        label="START\nPRD-PREFECT-DISPATCH-001"
        handler="start"
        status="validated"
        style=filled
        fillcolor=lightgreen
    ];

    // ===== STAGE 1: INDEPENDENT EPICS =====

    // Epic 4 — Catch-Up Poller (P0, no deps, FIRST to implement)
    epic4_catchup_poller [
        shape=box
        label="Epic 4\nCatch-Up Poller\nfor Orphaned Tasks"
        handler="codergen"
        bead_id="claude-harness-setup-kix9"
        worker_type="backend-solutions-engineer"
        acceptance="Prefect flow catches call_scheduled tasks stuck >30min. S3 transcript downloaded. PostCallProcessor runs. Idempotency via SELECT FOR UPDATE SKIP LOCKED."
        file_path="prefect_flows/catch_up_poller.py,scheduler/scheduler_service.py"
        promise_ac="AC-2"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        status="impl_complete"
        style=filled
        fillcolor="lightsalmon"
    ];

    // Epic 3 — pg_notify LISTEN Reconnection (P1, no deps, can run parallel with Epic 4)
    epic3_pg_notify_reconnect [
        shape=box
        label="Epic 3\npg_notify LISTEN\nReconnection"
        handler="codergen"
        bead_id="claude-harness-setup-x81a"
        worker_type="backend-solutions-engineer"
        acceptance="Heartbeat SELECT 1 every 30s. Auto-reconnect with exponential backoff 1s-60s. WARNING log on drop. Health check reflects listener_active status."
        file_path="scheduler/scheduler_service.py"
        promise_ac="AC-2"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        status="impl_complete"
        style=filled
        fillcolor="lightsalmon"
    ];

    start -> epic4_catchup_poller [label="begin"];
    start -> epic3_pg_notify_reconnect [label="begin"];

    // ===== STAGE 1 VALIDATION =====

    validate_epic4_tech [
        shape=hexagon
        label="Epic 4\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-kix9-TECH"
        acceptance="catch_up_poller_flow exists, SELECT FOR UPDATE SKIP LOCKED, S3 download, PostCallProcessor invocation"
        files="prefect_flows/catch_up_poller.py"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_epic3_tech [
        shape=hexagon
        label="Epic 3\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-x81a-TECH"
        acceptance="heartbeat coroutine, exponential backoff, WARNING log, health check listener_active field"
        files="scheduler/scheduler_service.py"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    epic4_catchup_poller -> validate_epic4_tech [label="impl_complete"];
    epic3_pg_notify_reconnect -> validate_epic3_tech [label="impl_complete"];

    // ===== STAGE 2: DEPENDENT EPICS =====

    // Epic 1 — Migrate Call Dispatch to Prefect (P0, depends on Epic 4)
    epic1_call_dispatch [
        shape=box
        label="Epic 1\nMigrate Call Dispatch\nto Prefect"
        handler="codergen"
        bead_id="claude-harness-setup-gqa8"
        worker_type="backend-solutions-engineer"
        acceptance="voice_verification_flow starts immediately. wait_for_stream_event catches Redis event within 60s. PostCallProcessor runs inline. local_mock mode E2E passes."
        file_path="prefect_flows/voice_verification.py,scheduler/scheduler_service.py"
        promise_ac="AC-2"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        status="impl_complete"
        style=filled
        fillcolor="lightsalmon"
    ];

    validate_epic4_tech -> epic1_call_dispatch [label="epic4 validated" condition="pass"];
    // Epic 1 does NOT wait for Epic 3 — they are independent

    validate_epic1_tech [
        shape=hexagon
        label="Epic 1\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-gqa8-TECH"
        acceptance="voice_verification_flow dispatches call, wait_for_stream_event, PostCallProcessor inline, existing tests pass"
        files="prefect_flows/voice_verification.py"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    epic1_call_dispatch -> validate_epic1_tech [label="impl_complete"];

    // ===== STAGE 3: AUDIT =====

    // Epic 2 — Email Dispatch Audit (P1, depends on Epic 1)
    epic2_email_audit [
        shape=box
        label="Epic 2\nVerify Email\nDispatch"
        handler="codergen"
        bead_id="claude-harness-setup-gzqf"
        worker_type="backend-solutions-engineer"
        acceptance="Zero active email dispatch paths in scheduler. email_outreach_flow exclusively owns email. orchestrator routes to email correctly. Business hours applied."
        file_path="scheduler/scheduler_service.py,prefect_flows/email_outreach.py,prefect_flows/bridge/prefect_bridge.py"
        promise_ac="AC-2"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        status="impl_complete"
        style=filled
        fillcolor="lightsalmon"
    ];

    validate_epic1_tech -> epic2_email_audit [label="epic1 validated" condition="pass"];

    validate_epic2_tech [
        shape=hexagon
        label="Epic 2\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-gzqf-TECH"
        acceptance="grep scheduler for sendgrid/smtp/email returns zero. email_outreach_flow verified. orchestrator routing confirmed."
        files="scheduler/scheduler_service.py,prefect_flows/email_outreach.py"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    epic2_email_audit -> validate_epic2_tech [label="impl_complete"];

    // ===== STAGE 4: DEPRECATION =====

    // Epic 5 — Scheduler Deprecation (P2, depends on Epics 1,2,3)
    epic5_scheduler_deprecation [
        shape=box
        label="Epic 5\nScheduler\nDeprecation"
        handler="codergen"
        bead_id="claude-harness-setup-57k5"
        worker_type="backend-solutions-engineer"
        acceptance="scheduler/ directory deleted. Zero imports/references. pg_notify fallback removed from voice agent. Removed from docker-compose. CI passes. No stuck tasks."
        file_path="scheduler/,docker-compose.prefect.yaml"
        promise_ac="AC-2"
        prd_ref="PRD-PREFECT-DISPATCH-001"
        status="impl_complete"
        style=filled
        fillcolor="lightsalmon"
    ];

    validate_epic2_tech -> epic5_scheduler_deprecation [label="epic2 validated" condition="pass"];
    validate_epic3_tech -> epic5_scheduler_deprecation [label="epic3 validated" condition="pass"];

    validate_epic5_tech [
        shape=hexagon
        label="Epic 5\nTechnical\nValidation"
        handler="wait.human"
        gate="technical"
        mode="technical"
        bead_id="AT-57k5-TECH"
        acceptance="scheduler/ gone, zero references, pg_notify removed, docker-compose clean, CI passes"
        files="scheduler/"
        promise_ac="AC-4"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    epic5_scheduler_deprecation -> validate_epic5_tech [label="impl_complete"];

    // ===== FINALIZE =====

    finalize [
        shape=Msquare
        label="FINALIZE\nPipeline Complete\ncs-verify"
        handler="exit"
        promise_id="promise-0bef990d"
        promise_ac="AC-5"
        status="validated"
        style=filled
        fillcolor="lightgreen"
    ];

    validate_epic5_tech -> finalize [label="all validated" condition="pass"];

}
