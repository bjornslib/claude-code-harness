---
title: "Completion Promise Cli"
status: active
type: skill
last_verified: 2026-02-19
grade: authoritative
---

# Completion Promise CLI Reference (v2.0)

File-based state tracking that ensures sessions only complete when user goals are verifiably achieved, using structured acceptance criteria.

---

## Core Concept

Every session has a **Completion Promise** with explicit **Acceptance Criteria** (ACs). The session cannot end until all ACs are met with evidence. This replaces the v1.0 goal/epic/feature hierarchy with a flat, evidence-driven model.

```
User Prompt --> Create Promise + ACs --> Meet ACs with Evidence --> Verify Completion --> Allow Stop
```

**Why This Matters**: The stop hook (`CompletionPromiseChecker` in `unified_stop_gate/checkers.py`) enforces this -- if ACs are not all met, the session cannot end.

---

## Session ID: Auto-Generated by ccsystem3

**For main System 3 sessions**: `CLAUDE_SESSION_ID` is **automatically set** by the `ccsystem3` shell function. You do NOT need to run `cs-init`.

**For tmux-spawned orchestrators**: You must set `CLAUDE_SESSION_ID` manually before launching Claude Code:
```bash
export CLAUDE_SESSION_ID="orch-[name]"
```

**Verify your session ID:**
```bash
echo $CLAUDE_SESSION_ID
```

---

## CLI Commands

All scripts are in `.claude/scripts/completion-state/`:

| Command | Purpose |
|---------|---------|
| `cs-promise --create "Title" --ac "AC text" --ac "AC text"` | Create promise with acceptance criteria (`--ac` REQUIRED) |
| `cs-promise --list` | List all promises with AC progress |
| `cs-promise --mine` | List only my promises |
| `cs-promise --show <id>` | Show promise details with AC status |
| `cs-promise --start <id>` | Set promise to `in_progress` |
| `cs-promise --add-ac <id> "Text"` | Add criterion to existing promise |
| `cs-promise --adopt <id>` | Adopt an orphaned promise |
| `cs-promise --release <id>` | Release ownership (orphan) |
| `cs-promise --cancel <id>` | Cancel promise |
| `cs-promise --meet <id> --ac-id AC-1 --evidence "proof" [--type test]` | Mark criterion met with evidence |
| `cs-verify --check` | Check if session can end |
| `cs-status` | Show completion state overview |

**Evidence types**: `test`, `manual`, `api`, `browser`, `log`, `review` (default: `manual`)

**Status lifecycle**: `pending` -> `in_progress` -> `verified` | `cancelled`

---

## Session Initialization Workflow

### Step 1: Verify Session ID

For main System 3 sessions, `CLAUDE_SESSION_ID` is already set by `ccsystem3`:
```bash
echo $CLAUDE_SESSION_ID
```

For tmux-spawned orchestrators, set it manually before launching Claude:
```bash
export CLAUDE_SESSION_ID="orch-[name]"
```

### Step 2: Create Promise with Acceptance Criteria

```bash
# From the user's goal -- ACs are REQUIRED
cs-promise --create "Complete user authentication feature with tests" \
    --ac "Login endpoint returns JWT on valid credentials" \
    --ac "Invalid credentials return 401 with error message" \
    --ac "All unit tests pass" \
    --ac "E2E test covers login flow"
```

### Step 3: Start Work

```bash
# pending -> in_progress
cs-promise --start <promise-id>
```

### Step 4: (Optional) Add More ACs as Scope Becomes Clear

```bash
cs-promise --add-ac <promise-id> "Rate limiting applied to login endpoint"
```

### Step 5: (Optional) Check for Orphaned Promises

```bash
cs-status --orphans
```

---

## During Work: Meeting Acceptance Criteria

### View Progress

```bash
# View your active promises with AC status
cs-promise --mine

# Show detailed AC breakdown
cs-promise --show <promise-id>
```

### Mark Criteria Met with Evidence

**CRITICAL**: Every AC requires evidence, not just assertions.

```bash
# After tests pass
cs-promise --meet <promise-id> --ac-id AC-1 --evidence "pytest tests/test_auth.py -- 5/5 passed" --type test

# After API verification
cs-promise --meet <promise-id> --ac-id AC-2 --evidence "POST /login with bad creds returns 401" --type api

# After manual check
cs-promise --meet <promise-id> --ac-id AC-3 --evidence "All 12 unit tests green" --type test

# After E2E run
cs-promise --meet <promise-id> --ac-id AC-4 --evidence "Playwright login_flow.spec.ts passed" --type browser
```

### Ownership Management

```bash
# Release ownership if handing off to another session
cs-promise --release <promise-id>

# Adopt an orphaned promise from a crashed session
cs-promise --adopt <promise-id>

# Cancel a promise that is no longer needed
cs-promise --cancel <promise-id>
```

---

## Stop Hook Integration

The `CompletionPromiseChecker` in `unified_stop_gate/checkers.py` evaluates promise status:

| Exit Code | Meaning | Result |
|-----------|---------|--------|
| 0 | No owned promises OR all ACs met | Session can end |
| 2 | Owned promises have unmet ACs | Session blocked |

### When Blocked

You will see a message like:

```
COMPLETION CRITERIA NOT MET

Session: 20260110T142532Z-a7f3b9e1

IN_PROGRESS PROMISES (1):
  promise-b1afb394: "Complete user authentication feature with tests"
    AC-1: [MET]  Login endpoint returns JWT on valid credentials
    AC-2: [MET]  Invalid credentials return 401 with error message
    AC-3: [UNMET] All unit tests pass
    AC-4: [UNMET] E2E test covers login flow

NEXT ACTION:
  Meet remaining criteria:
    cs-promise --meet promise-b1afb394 --ac-id AC-3 --evidence "..." --type test
    cs-promise --meet promise-b1afb394 --ac-id AC-4 --evidence "..." --type browser
```

**Response**: Continue working on the unmet ACs -- don't try to force the stop.

**Orphan Warnings**: The checker warns about orphaned `in_progress` promises but does not block on them.

---

## Checking Status

```bash
# Full status overview (all sessions)
cs-status

# Only my promises
cs-status --mine

# Check for orphaned promises
cs-status --orphans

# View history (verified/cancelled)
cs-status --history

# JSON output for programmatic access
cs-status --json

# Check if session can end (for scripts)
cs-verify --check
```

---

## Promise JSON Schema (v2.0)

```json
{
    "id": "promise-{8hex_chars}",
    "summary": "Description of the promise",
    "acceptance_criteria": [
        {
            "id": "AC-1",
            "description": "Criterion text",
            "met": false,
            "evidence": null,
            "evidence_type": null,
            "met_at": null
        }
    ],
    "ownership": {
        "created_by": "session-id",
        "created_at": "timestamp",
        "owned_by": "session-id",
        "owned_since": "timestamp"
    },
    "status": "pending|in_progress|verified|cancelled"
}
```

---

## Verification Sub-Agent Pattern

For thorough verification, spawn a dedicated agent:

```python
Task(
    subagent_type="general-purpose",
    model="sonnet",
    description="Verify completion criteria",
    prompt="""
    List promises owned by this session: cs-promise --mine

    For each in_progress promise:
    1. Read the acceptance criteria: cs-promise --show <id>
    2. For each unmet AC, run relevant tests or checks
    3. Collect evidence/proof for each criterion

    Then meet each criterion:
    cs-promise --meet <id> --ac-id AC-N --evidence "Evidence of completion" --type test

    Report what was verified and any gaps found.
    """
)
```

---

## Integration with Orchestrators

When spawning orchestrators, inject completion context:

```python
# Include in wisdom injection
completion_context = Bash("cs-status --json")

wisdom = f"""
## Active Completion Promises
{completion_context}

Report completion with:
  cs-promise --meet <id> --ac-id AC-N --evidence "Evidence..." --type test

If blocked, use:
  cs-promise --release <id>  # To hand off to another session
"""
```

---

## Quick Reference

| Phase | Commands |
|-------|----------|
| **Session Start** | Verify `$CLAUDE_SESSION_ID`, then `cs-promise --create "..." --ac "..."` |
| **Begin Work** | `cs-promise --start <id>` |
| **During Work** | `cs-promise --meet <id> --ac-id AC-N --evidence "..." --type test` |
| **Check Progress** | `cs-promise --show <id>`, `cs-status` |
| **Before Stop** | `cs-verify --check` (automatic via hook) |

**Remember**: The completion promise is what the user asked for, not what you decided to do. Extract acceptance criteria from their original request.

---

**Version**: 2.0.0
**Source**: Completion Promise Protocol -- consolidated from completion-promise.md + completion-promise-cli.md (v1.0)
